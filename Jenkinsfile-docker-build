pipeline {
    agent any
    environment {
        NEXUS_URL = 'http://nexus:8081/repository/maven-releases'
        GROUP_ID = 'org/springframework/samples'
        ARTIFACT_ID = 'spring-framework-petclinic'
        VERSION = '5.2.4'
        WAR_NAME = 'petclinic.war'
        DOCKER_IMAGE = 'petclinic-app'
        CONTAINER_NAME = 'petclinic-container'
        NEXUS_CREDENTIALS = credentials('nexuslogin')
    }
    stages {
        stage('Download Artifact from Nexus') {
            steps {
                script {
                    def artifactUrl = "${NEXUS_URL}/${GROUP_ID}/${ARTIFACT_ID}/${VERSION}/${ARTIFACT_ID}-${VERSION}.war"
                    sh "curl -u ${NEXUS_CREDENTIALS} -o ${WAR_NAME} ${artifactUrl}"
                }
            }
        }
        stage('Build and Run Docker Image') {
            steps {
                script {
                    // Build the image
                    //def app = docker.build("${DOCKER_IMAGE}:${VERSION}")
                    sh "docker build -t ${DOCKER_IMAGE}:${VERSION} ."
                    // Check if container exists and remove it if it does
                    sh """
                        if [ "\$(docker ps -aq -f name=${CONTAINER_NAME})" ]; then
                            docker rm -f ${CONTAINER_NAME}
                        fi
                    """

                    // Run the new container
                    sh "docker run --name ${CONTAINER_NAME} -p 30080:8080 ${DOCKER_IMAGE}:${VERSION}"
                    //app.run("--name ${CONTAINER_NAME} -p 30080:8080")
                }
            }
        }
    }
    //post {
        //success {
            //script {
                // Notify GitHub of success
                // This assumes the GitHub plugin is installed
                //githubNotify description: 'Docker Build Succeeded', status: 'SUCCESS', context: 'jenkins/docker-build'
            //}
        //}
        //failure {
            //script {
                // Notify GitHub of failure
                //githubNotify description: 'Docker Build Failed', status: 'FAILURE', context: 'jenkins/docker-build'
            //}
        }
    //}
//}
