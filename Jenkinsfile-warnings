pipeline {
    agent any
    tools {
        // Install the Maven version configured as "Maven3.9.12" and add it to the path.
        maven "Maven3.9.12"
        jdk 'Corretto-17'
    }
    options {
        ansiColor('xterm')
    }
    stages {
        stage('Build & Analysis') {
            steps {
                // On lance la compilation et les outils d'analyse
                // checkstyle:checkstyle et pmd:pmd génèrent les XML
                sh 'mvn clean verify checkstyle:checkstyle pmd:pmd'
            }
        }

        stage('Reporting Violations') {
            steps {
                script {
                    // Utilisation du plugin Warnings Next Generation
                    recordIssues(
                        enabledForFailure: true,
                        aggregatingResults: true,
                        tools: [
                            checkStyle(pattern: '**/target/checkstyle-result.xml'),
                            pmdParser(pattern: '**/target/pmd.xml'),
                            spotBugs(pattern: '**/target/spotbugsXml.xml'),
                            java() // Capture aussi les warnings de compilation javac
                        ],
                        // Optionnel : Définir des seuils pour faire échouer le build
                        qualityGates: [[threshold: 10, type: 'TOTAL', unstable: true]]
                    )
                }
            }
        }
    }
    post {
        success {
            script {
                echo "\033[32mBuild Successful!\033[0m"
            }
        }
        unstable {
            script {
                echo "\033[33mBuild Unstable - Check Warnings!\033[0m"
            }
        }
        failure {
            script {
                echo "\033[31mBuild Failed!\033[0m"
            }
        }
    }
}
